# 録音機能 - 要件定義

## 概要

NoteAI Plusアプリの中核となる音声録音機能を実装する。高品質な音声録音、バックグラウンド対応、直感的なUI、音声レベル監視を提供し、ユーザーが簡単に音声を記録できるようにする。

## 機能要件

### FR1: 基本録音機能

#### FR1.1 録音開始・停止
- **要件**: ユーザーがワンタップで録音を開始・停止できる
- **詳細**:
  - 録音ボタンタップで即座に録音開始
  - 再度タップで録音停止・保存
  - 録音中は視認性の高い録音中表示
  - 録音状態の明確な視覚フィードバック

#### FR1.2 録音一時停止・再開
- **要件**: 録音中に一時停止・再開が可能
- **詳細**:
  - 一時停止ボタンで録音を一時中断
  - 再開ボタンで同じファイルで録音継続
  - 一時停止中の経過時間表示
  - 一時停止状態の明確な表示

#### FR1.3 録音時間表示
- **要件**: リアルタイムで録音時間を表示
- **詳細**:
  - 00:00:00形式での時分秒表示
  - 1秒間隔での更新
  - 見やすい大きなフォント
  - モノスペースフォント使用

### FR2: 音声品質管理

#### FR2.1 音質設定
- **要件**: ユーザーが音質レベルを選択可能
- **詳細**:
  - 高音質（256kbps）: 会議・インタビュー用
  - 中音質（128kbps）: 日常使用・バランス重視
  - 低音質（64kbps）: 長時間録音・容量重視
  - 設定は永続化される

#### FR2.2 ファイル形式選択
- **要件**: 録音ファイル形式を選択可能
- **詳細**:
  - m4a形式: デフォルト、圧縮効率良い
  - wav形式: 非圧縮、最高品質
  - 形式選択はアプリ設定で変更
  - 既存録音に影響しない

#### FR2.3 音声レベル監視
- **要件**: リアルタイムで音声レベルを表示
- **詳細**:
  - 波形表示でレベル可視化
  - 音声が小さすぎる場合の警告
  - 音声が大きすぎる場合の警告
  - レベルメーター表示

### FR3: バックグラウンド録音

#### FR3.1 アプリ終了後の継続録音
- **要件**: アプリを閉じても録音継続
- **詳細**:
  - iOS Background Modes対応
  - バックグラウンド録音許可設定
  - 通知領域での録音状態表示
  - アプリ復帰時の状態同期

#### FR3.2 画面ロック中の録音
- **要件**: 画面ロック中も録音継続
- **詳細**:
  - ロック画面での録音時間表示
  - Control Centerからの操作対応
  - 電話着信時の一時停止・再開

### FR4: ファイル管理

#### FR4.1 自動ファイル名生成
- **要件**: 録音ファイルに自動で意味のある名前を設定
- **詳細**:
  - デフォルト形式: "録音 YYYY-MM-DD HH:mm"
  - 重複時の連番追加
  - ユーザーによる名前編集可能
  - 日時情報の保持

#### FR4.2 ファイル保存場所
- **要件**: 録音ファイルを適切な場所に保存
- **詳細**:
  - Documents Directory内の専用フォルダ
  - iCloudバックアップ対象
  - ファイル容量の監視
  - 古いファイルの自動削除設定

### FR5: エラーハンドリング

#### FR5.1 権限エラー対応
- **要件**: マイク権限がない場合の適切な対応
- **詳細**:
  - 初回起動時の権限要求
  - 権限拒否時の説明表示
  - 設定アプリへの遷移案内
  - 権限状態の監視

#### FR5.2 容量不足対応
- **要件**: ストレージ不足時の適切な対応
- **詳細**:
  - 録音開始前の容量チェック
  - 録音中の容量監視
  - 容量不足時の警告・停止
  - 自動容量最適化提案

#### FR5.3 デバイスエラー対応
- **要件**: マイクデバイスエラー時の対応
- **詳細**:
  - デバイス接続状態の監視
  - 外部マイク接続・切断の検知
  - オーディオセッション割り込みの処理
  - エラー時の適切なメッセージ表示

## 非機能要件

### NFR1: パフォーマンス
- **応答性**: 録音開始・停止の反応時間 < 100ms
- **CPU使用率**: バックグラウンド録音時 < 5%
- **メモリ使用量**: 録音中の追加メモリ < 50MB
- **バッテリー**: 1時間録音でのバッテリー消費 < 20%

### NFR2: 可用性
- **稼働率**: アプリクラッシュ率 < 0.1%
- **復旧性**: エラー後の自動復旧機能
- **耐久性**: 長時間録音（8時間以上）対応
- **並行性**: 録音中の他機能使用可能

### NFR3: ユーザビリティ
- **直感性**: 初回使用者が説明なしで使用可能
- **アクセシビリティ**: VoiceOver完全対応
- **視認性**: 暗い環境での視認性確保
- **操作性**: 片手での操作性

### NFR4: セキュリティ
- **プライバシー**: 録音データのローカル保存
- **暗号化**: ファイルシステムレベルでの暗号化
- **権限**: 最小権限の原則
- **監査**: 録音操作のログ記録

## 技術制約

### TC1: iOS要件
- **最小OS**: iOS 16.0以上
- **デバイス**: iPhone専用（iPad将来対応）
- **アーキテクチャ**: arm64必須
- **フレームワーク**: AVFoundation使用必須

### TC2: 音声制約
- **サンプリング**: 44.1kHz推奨
- **ビット深度**: 16bit以上
- **チャンネル**: モノラル・ステレオ対応
- **遅延**: 録音開始遅延 < 50ms

### TC3: ストレージ制約
- **最大ファイルサイズ**: 4GB（FAT32制限考慮）
- **並行録音**: 同時録音は1セッションのみ
- **形式**: AVFoundation対応形式のみ
- **メタデータ**: 標準的なオーディオタグ対応

## 受け入れ条件

### AC1: 基本機能
- [ ] ワンタップで録音開始・停止可能
- [ ] 録音中の時間が正確に表示される
- [ ] 一時停止・再開が正常に動作
- [ ] バックグラウンド録音が継続される
- [ ] 音声レベルがリアルタイム表示される

### AC2: 品質管理
- [ ] 高・中・低音質での録音が可能
- [ ] m4a・wav形式での保存が可能
- [ ] 音質設定が永続化される
- [ ] ファイルサイズが適切な範囲内

### AC3: ユーザビリティ
- [ ] 直感的なUI操作が可能
- [ ] エラー時に適切なメッセージ表示
- [ ] マイク権限の適切な管理
- [ ] VoiceOver対応

### AC4: パフォーマンス
- [ ] 録音開始の遅延が50ms以下
- [ ] 8時間以上の連続録音が可能
- [ ] アプリクラッシュ率0.1%以下
- [ ] バッテリー消費が妥当な範囲

## 除外事項

### EX1: 高度な音声処理
- リアルタイム音声エフェクト
- 録音中のノイズ除去
- 自動音量調整
- マルチトラック録音

### EX2: 外部連携
- 他アプリとの直接連携
- SNS への直接投稿
- 音声ファイルの直接共有
- 外部クラウドサービス連携

### EX3: 高度なUI
- 複雑な波形編集機能
- 音声の部分カット機能
- 複数録音の同時表示
- 高度な視覚化機能

## 参考資料

- [Apple AVFoundation Documentation](https://developer.apple.com/documentation/avfoundation/)
- [iOS Background Execution Guidelines](https://developer.apple.com/documentation/backgroundtasks/)
- [Human Interface Guidelines - Audio](https://developer.apple.com/design/human-interface-guidelines/playing-audio)
- [Core Audio Overview](https://developer.apple.com/library/archive/documentation/MusicAudio/Conceptual/CoreAudioOverview/Introduction/Introduction.html)